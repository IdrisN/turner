var maxImgDimPx=120,elementIDToLink={"company-logo":"https://www.darmstadt-graphics.com/","product-logo":"https://dgg3d.github.io/turner"},buttonsEnabled=!0,elementImageCustomization={"company-logo":"","product-logo":"","three-d-icon":""},environmentMapCustomization="",customModelFileURL="",engine=null,sceneObj=null,mainMesh=null,camera=null,renderPipeline=null,postProcess=null,currentSkybox=null,currentSkyboxScale=null,currentSkyboxBlurLevel=null,turnerInput=null,initModelRoughness=0,initModelMetallic=0,refScale=3.5,isFirefoxOrIceweasel=navigator.userAgent.indexOf("Firefox")>=0||navigator.userAgent.indexOf("Iceweasel")>=0;isFirefoxOrIceweasel?window.addEventListener("DOMMouseScroll",function(e){e.preventDefault()}):window.addEventListener("mousewheel",function(e){e.preventDefault()},{passive:!1});var viewerIsReadyCallbacks=[],viewerReady=!1,modelIsLoadedCallbacks=[],modelLoaded=!1;function emitViewerReady(){viewerReady=!0;for(var e=0;e<viewerIsReadyCallbacks.length;++e)viewerIsReadyCallbacks[e]()}function emitModelLoaded(){modelLoaded=!0;for(var e=0;e<modelIsLoadedCallbacks.length;++e)modelIsLoadedCallbacks[e]()}var TurnerWheelFOVInput=function(e,n,t){this.inertialFovOffset=0,this.scaling=.001,this.camera=e,this.minFOV=n,this.maxFOV=t};function toggleObjectSpaceNormalMap(e){e&&sceneObj.meshes.forEach(function(e){e.material&&(e.material.useObjectSpaceNormalMap=!0)})}function setupMainMesh(){mainMesh=new BABYLON.Mesh("mainModelMesh",sceneObj);var e=new BABYLON.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new BABYLON.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);sceneObj.meshes.forEach(function(t){if(t!==mainMesh){t.material&&(t.material.forceIrradianceInFragment=!0,t.material.backFaceCulling=!1),t.computeWorldMatrix(!0);var r=t.getBoundingInfo().boundingBox.minimumWorld,o=t.getBoundingInfo().boundingBox.maximumWorld;BABYLON.Tools.CheckExtends(r,e,n),BABYLON.Tools.CheckExtends(o,e,n),t.setParent(mainMesh)}});var t=n.subtract(e),r=.5*t.length(),o=e.add(t.multiplyByFloats(.5,.5,.5)),a=refScale/(2*r);mainMesh.scaling=new BABYLON.Vector3(a,a,a),mainMesh.translate(o.negate(),BABYLON.Space.WORLD)}function addOSNormalMapPluginHook(e){e.onParsed=function(n){if(n.json.materials[0]&&n.json.materials[0].normalTexture){var t=n.json.materials[0].normalTexture;t.extras&&t.extras.objectSpaceNormals&&(console.log("Asset seems to have an object-space normal map. Triggering object-space normal mapping."),e.onComplete=function(){toggleObjectSpaceNormalMap(!0)})}}}function loadScene(){engine&&engine.dispose(),(engine=new BABYLON.Engine(canvas,!0)).enableOfflineSupport=!1,engine.loadingUIBackgroundColor="#f8f8f8";BABYLON.SceneLoader.ShowLoadingScreen=!0,BABYLON.SceneLoader.ForceFullSceneLoadingForIncremental=!0,addOSNormalMapPluginHook(BABYLON.SceneLoader.Load("","scene.glb",engine,function(e){sceneObj=e,e.defaultCursor="grab",sceneObj.onPointerDown=function(){e.defaultCursor="grabbing"},sceneObj.onPointerUp=function(){e.defaultCursor="grab",canvas.style.cursor="grab"},sceneObj.clearColor=new BABYLON.Color4(.66,.66,.66,0),setupMainMesh();(camera=new BABYLON.ArcRotateCamera("camera",0,0,3,BABYLON.Vector3.Zero(),sceneObj)).inputs.removeByType("ArcRotateCameraMouseWheelInput");var n=27*Math.PI/180,t=54*Math.PI/180;turnerInput=new TurnerWheelFOVInput(camera,n,t),camera.inputs.add(turnerInput);var r=new BABYLON.Vector3(0,0,0);camera.fov=.66;var o=.5*refScale/Math.tan(.5*camera.fov),a=r.add(new BABYLON.Vector3(0,0,o));camera.setPosition(a),camera.setTarget(r),camera.lowerRadiusLimit=.3*o,camera.upperRadiusLimit=1.5*o,camera.minZ=.1*camera.lowerRadiusLimit,camera.maxZ=10*camera.upperRadiusLimit,camera.wheelPrecision*=20,camera.pinchPrecision*=20,camera.attachControl(canvas,!0),sceneObj.environmentTexture=new BABYLON.CubeTexture.CreateFromPrefilteredData("images/environment.dds",sceneObj),currentSkyboxScale=4*camera.upperRadiusLimit,currentSkyboxBlurLevel=.5,currentSkybox=sceneObj.createDefaultSkybox(sceneObj.environmentTexture,!0,currentSkyboxScale,currentSkyboxBlurLevel),(renderPipeline=new BABYLON.DefaultRenderingPipeline("default",!0,sceneObj,[camera])).fxaaEnabled=!0,renderPipeline.bloomEnabled=!0,renderPipeline.bloomWeight=.5,(postProcess=renderPipeline.imageProcessing).contrast=1,postProcess.exposure=1,emitViewerReady(),initModelRoughness=getItemRoughnessFactor(),initModelMetallic=getItemMetallicFactor(),emitModelLoaded(),engine.runRenderLoop(function(){sceneObj.render()})}))}TurnerWheelFOVInput.prototype.getTypeName=function(){return"TurnerWheelFOVInput"},TurnerWheelFOVInput.prototype.getSimpleName=function(){return"wheelFOV"},TurnerWheelFOVInput.prototype.attachControl=function(e,n){if(!this._wheel){var t=this.camera,r=this;this._wheel=function(e,n){if(e.type===BABYLON.PointerEventTypes.POINTERWHEEL){var t,o=e.event;if(o.wheelDelta)t=.025*-o.wheelDelta*r.scaling;else{t=(o.deltaY||o.detail)*r.scaling}r.inertialFovOffset+=t}},this._observer=t.getScene().onPointerObservable.add(this._wheel,BABYLON.PointerEventTypes.POINTERWHEEL)}},TurnerWheelFOVInput.prototype.detachControl=function(e){this._observer&&e&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null)},TurnerWheelFOVInput.prototype.checkInputs=function(e){(0!=this.inertialFovOffset||e)&&(this.camera.fov+=this.inertialFovOffset,this.camera.fov=Math.max(this.minFOV,Math.min(this.maxFOV,this.camera.fov)),this.inertialFovOffset*=this.camera.inertia,Math.abs(this.inertialFovOffset)<BABYLON.Epsilon&&(this.inertialFovOffset=0))};var viewerIsReady=function(){return viewerReady},addIsReadyCallback=function(e){viewerIsReady()?e():viewerIsReadyCallbacks.push(e)},modelIsLoaded=function(){return modelLoaded},addModelLoadedCallback=function(e){modelIsLoaded()?e():modelIsLoadedCallbacks.push(e)},setModelFromFile=function(e){modelLoaded=!1,addOSNormalMapPluginHook(BABYLON.SceneLoader.Append("file:",e,sceneObj,function(n){var t=null!=currentSkybox;t&&toggle3DBackground(!1),mainMesh.dispose(),setupMainMesh(),t&&toggle3DBackground(!0);var r=new FileReader;r.onloadend=function(){customModelFileURL=r.result},r.readAsDataURL(e),initModelRoughness=getItemRoughnessFactor(),initModelMetallic=getItemMetallicFactor(),emitModelLoaded()},null,function(){console.error("Unable to load model.")}))},getCustomModelFileURL=function(){return customModelFileURL},toggle3DBackground=function(e){e&&null==currentSkybox?currentSkybox=sceneObj.createDefaultSkybox(sceneObj.environmentTexture,!0,currentSkyboxScale,currentSkyboxBlurLevel):e||null==currentSkybox||(currentSkybox.dispose(),currentSkybox=null),renderPipeline.fxaaEnabled=!!e},setSkyboxSharpness=function(e){currentSkyboxBlurLevel=1-e,currentSkybox&&(currentSkybox.dispose(),currentSkybox=sceneObj.createDefaultSkybox(sceneObj.environmentTexture,!0,currentSkyboxScale,currentSkyboxBlurLevel))},setMinVerticalCameraAngle=function(e){camera.upperBetaLimit=(180-(e+90))/180*Math.PI},setMaxVerticalCameraAngle=function(e){camera.lowerBetaLimit=(180-(e+90))/180*Math.PI},setMinZoomFactor=function(e){e=Math.max(Math.min(e,10),1),turnerInput.minFOV=9*e*Math.PI/180,turnerInput.checkInputs(!0)},setMaxZoomFactor=function(e){e=Math.max(Math.min(e,10),1),turnerInput.maxFOV=9*e*Math.PI/180,turnerInput.checkInputs(!0)},setPanningSensitivity=function(e){camera.panningSensibility=e>0?4e3*(1.1-e):0},setContrast=function(e){postProcess.contrast=e},setExposure=function(e){postProcess.exposure=e},setBloom=function(e){renderPipeline.bloomEnabled=e>0,renderPipeline.bloomWeight=e},setEnvironmentMap=function(e){sceneObj.environmentTexture&&sceneObj.environmentTexture.dispose(),sceneObj.environmentTexture=new BABYLON.CubeTexture.CreateFromPrefilteredData(e,sceneObj),null!=currentSkybox&&(currentSkybox.dispose(),currentSkybox=sceneObj.createDefaultSkybox(sceneObj.environmentTexture,!0,currentSkyboxScale,currentSkyboxBlurLevel)),environmentMapCustomization=e},getEnvironmentMapCustomURL=function(){return environmentMapCustomization},toggleButtons=function(e){if(e!=buttonsEnabled){for(var n in buttonsEnabled=e,elementIDToLink)if(elementIDToLink.hasOwnProperty(n)){var t=document.getElementById(n);if(!t)continue;buttonsEnabled&&""!=elementIDToLink[n]?t.setAttribute("href",elementIDToLink[n]):t.setAttribute("href","javascript:void(0)")}}else buttonsEnabled=e},toggleElementVisibility=function(e,n){var t=document.getElementById(e);t?t.style.visibility=n?"visible":"hidden":console.error('Cannot find element with ID "'+e+'".')},setElementImage=function(e,n){var t=document.getElementById(e);if(t){var r=new Image;r.crossOrigin="anonymous",r.onload=function(){var n=maxImgDimPx,o=maxImgDimPx,a=r.width,i=r.height;(a>n||i>o)&&(a>i?a>n&&(i*=n/a,a=n):i>o&&(a*=o/i,i=o));var l=document.createElement("canvas");l.setAttribute("width",a),l.setAttribute("height",i);var s=l.getContext("2d");s.width=a,s.height=i,s.drawImage(r,0,0,a,i);var c=l.toDataURL("image/png");t.style.backgroundImage="url('"+c+"')",elementImageCustomization[e]=c,t.style.width=a+"px",t.style.height=i+"px"},r.src=n}else console.error('Cannot find element with ID "'+e+'".')},getElementImageCustomURL=function(e){if(document.getElementById(e))return elementImageCustomization[e];console.error('Cannot find element with ID "'+e+'".')},setElementLink=function(e,n){if(elementIDToLink[e]=n,buttonsEnabled){e=e;var t=document.getElementById(e);if(!t)return void console.error('Cannot find element with ID "'+e+'".');""==n?t.setAttribute("href","javascript:void(0)"):t.setAttribute("href",n)}},getElementLink=function(e){if(document.getElementById(e))return elementIDToLink[e];console.error('Cannot find element with ID "'+e+'".')},setElementBackground=function(e,n){var t=document.getElementById(e);t?t.style.background=n:console.error('Cannot find element with ID "'+e+'".')},setElementPosition=function(e,n,t,r,o){var a=document.getElementById(e);if(a){var i="left"==n?"right":"left",l="top"==t?"bottom":"top";a.style[i]="inherit",a.style[l]="inherit",a.style[n]=r,a.style[t]=o}else console.error('Cannot find element with ID "'+e+'".')},getElementCustomCSS=function(e,n){var t=document.getElementById(e);if(t){for(var r="",o=0;o<t.style.length;++o){for(var a=t.style[o],i=!1,l=0;l<n.length;++l)if(n[l]==a){i=!0;break}i||(r+=a+":"+t.style[a]+";")}return r}console.error('Cannot find element with ID "'+e+'".')},getElementPosX=function(e){var n=document.getElementById(e);if(n)return n.offsetLeft;console.error('Cannot find element with ID "'+e+'".')},getElementPosY=function(e){var n=document.getElementById(e);if(n)return n.offsetTop;console.error('Cannot find element with ID "'+e+'".')},getElementWidth=function(e){var n=document.getElementById(e);if(n)return n.offsetWidth;console.error('Cannot find element with ID "'+e+'".')},getElementHeight=function(e){var n=document.getElementById(e);if(n)return n.offsetHeight;console.error('Cannot find element with ID "'+e+'".')},getViewerWidth=function(){return document.body.offsetWidth},getViewerHeight=function(){return document.body.offsetHeight},addElementPointerDownCallback=function(e,n){var t=document.getElementById(e);t?t.addEventListener("pointerdown",n):console.error('Cannot find element with ID "'+e+'".')},addPointerUpCallback=function(e){window.addEventListener("pointerup",e)},addPointerMoveCallback=function(e){window.addEventListener("pointermove",e)},getItemMetallicFactor=function(){for(var e=0;e<sceneObj.meshes.length;++e){var n=sceneObj.meshes[e];if(n.material&&null!=n.material.metallic)return n.material.metallic}return-1},setItemMetallicFactor=function(e){for(var n=0;n<sceneObj.meshes.length;++n){var t=sceneObj.meshes[n];t.material&&null!=t.material.metallic&&(t.material.metallic=e)}},getItemRoughnessFactor=function(){for(var e=0;e<sceneObj.meshes.length;++e){var n=sceneObj.meshes[e];if(n.material&&null!=n.material.roughness)return n.material.roughness}return-1},setItemRoughnessFactor=function(e){for(var n=0;n<sceneObj.meshes.length;++n){var t=sceneObj.meshes[n];t.material&&null!=t.material.roughness&&(t.material.roughness=e)}},getItemAsGLBBlob=function(e){var n={shouldExportTransformNode:function(e){return e!==currentSkybox}};BABYLON.GLTF2Export.GLBAsync(sceneObj,"scene",n).then(n=>{var t=n.glTFFiles["scene.glb"];e(t)})},itemIsUnchanged=function(){return initModelRoughness==getItemRoughnessFactor()&&initModelMetallic==getItemMetallicFactor()};
